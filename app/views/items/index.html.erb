<style>
  /* Estilos gerais (mantidos) */
  body { font-family: sans-serif; padding: 20px; }
  h1 { color: #333; }
  .items-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  .items-table th, .items-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
  .items-table th { background-color: #f2f2f2; }
  .items-table tr:nth-child(even) { background-color: #f9f9f9; }
  .items-table tr:hover { background-color: #f1f1f1; }
  .row-found { background-color: #e5ffedff !important; }
  .row-missing { background-color: #fff7b3ff !important; }
  .status-found { color: green; font-weight: bold; }

  /* --- ESTILOS DE BOT√ïES UNIFICADOS (ATUALIZADO) --- */
  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px; /* Bordas mais arredondadas */
    color: white;
    cursor: pointer;
    text-decoration: none;
    font-size: 14px; /* Tamanho de fonte consistente */
    font-weight: bold;
    transition: background-color 0.2s, transform 0.1s; /* Transi√ß√£o suave */
    display: inline-block; /* Garante alinhamento e padding corretos */
    text-align: center;
  }

  .btn:hover {
    filter: brightness(1.1); /* Efeito de brilho ao passar o mouse */
  }

  .btn:active {
    transform: scale(0.98); /* Efeito de clique */
  }

  /* Varia√ß√µes de cor */
  .btn-found { background-color: #28a745; } /* Verde para "Encontrado" */
  .btn-not-found { background-color: #8f8f8fff; } /* Amarelo para "N√£o Encontrado" */
  .btn-add { background-color: #007bff; } /* Azul para "Adicionar" */
  .btn-delete { background-color: #dc3545; } /* Vermelho para "Excluir" */

  /* Ajuste para o bot√£o de excluir ser mais compacto se preferir */
  .btn-delete {
    padding: 8px 12px; /* Menos padding lateral para √≠cone */
  }

  /* --- FIM DOS ESTILOS DE BOT√ïES --- */


  /* Estilos para grupos recolh√≠veis (mantidos) */
  .group-header {
    background-color: #e0e0e0; padding: 12px; margin-top: 20px; cursor: pointer;
    border-radius: 5px; font-weight: bold; display: flex; justify-content: space-between;
    align-items: center; user-select: none;
  }
  .group-header.category-header { background-color: #333; color: white; }
  .group-header.rarity-header { background-color: #f0f0f0; margin-top: 10px; margin-left: 20px; }
  .group-header .toggle-icon::before {
    content: '‚ñº'; display: inline-block; transition: transform 0.2s;
  }
  .group-header.collapsed .toggle-icon::before { transform: rotate(-90deg); }
  .items-container {
    padding-left: 20px; overflow: hidden; transition: max-height 0.3s ease-out;
  }
  .items-container.collapsed { max-height: 0 !important; padding-top: 0; padding-bottom: 0; margin-top: 0; }

  /* Estilos para o filtro de busca (mantidos) */
  .search-container { margin: 20px 0; }
  .search-input {
    width: 100%; padding: 12px; font-size: 16px; border-radius: 5px;
    border: 1px solid #ccc; box-sizing: border-box;
  }

  @media (max-width: 600px) {
  /* Faz com que a tabela ocupe a largura total, mas permite scroll horizontal se necess√°rio */
  .items-table {
    display: block; /* Muda o comportamento da tabela */
    overflow-x: auto; /* Adiciona scroll horizontal APENAS se o conte√∫do n√£o couber */
    white-space: nowrap; /* Evita que os bot√µes quebrem linha de forma estranha */
  }

  /* Garante que as c√©lulas n√£o tentem espremer demais o conte√∫do */
  .items-table td, .items-table th {
    padding: 8px 10px; /* Reduz um pouco o padding em ecr√£s pequenos */
  }

  /* Ajusta o tamanho da fonte para melhor leitura */
  .btn {
    font-size: 13px;
    padding: 8px 12px;
  }

  /* Remove a largura fixa das colunas de a√ß√£o para que se ajustem ao conte√∫do */
  .items-table th[style*="width: 10%"],
  .items-table td {
    width: auto !important; /* Permite que o browser calcule a largura necess√°ria */
  }
}
</style>


<h1>Checklist de Itens - Fallout</h1>
<p>Bem-vindo, <%= current_user.email %>!</p>

<!-- A√ß√£o do Cabe√ßalho -->
<div class="header-actions">
  <%# ATUALIZADO: Adicionada a classe "btn" para o estilo base %>
  <%= link_to "Adicionar Novo Item", new_item_path, class: "btn btn-add" %>
</div>

<!-- Estrutura de Itens Agrupados (sem altera√ß√µes aqui) -->
<% @items.group_by(&:category).each do |category, items_by_category| %>
  <div class="group-wrapper" data-category-name="<%= category.downcase %>">
    <div class="group-header category-header collapsible">
      <span><%= category %> (<%= items_by_category.count %>)</span>
      <span class="toggle-icon"></span>
    </div>
    <div class="items-container">
      <% items_by_category.group_by(&:rarity).each do |rarity, items_by_rarity| %>
        <div class="group-wrapper" data-rarity-name="<%= rarity.downcase %>">
          <div class="group-header rarity-header collapsible">
            <span><%= rarity %> (<%= items_by_rarity.count %>)</span>
            <span class="toggle-icon"></span>
          </div>
          <div class="items-container">
            <table class="items-table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th style="width: 10%;">A√ß√£o</th>
                  <th style="width: 10%;"></th>
                </tr>
              </thead>
              <tbody>
                <% items_by_rarity.each do |item| %>
                  <%# ATUALIZA√á√ÉO AQUI: Adiciona a classe din√¢mica ao <tr> %>
                  <% is_found = @found_item_ids.include?(item.id) %>
                  <tr id="item-row-<%= item.id %>" data-item-name="<%= item.name.downcase %>" class="<%= is_found ? 'row-found' : 'row-missing' %>">
                    <td><%= item.name %></td>
                    <td>
                      <%= form_with(url: toggle_found_item_path(item), method: :post) do %>
                        <button type="submit" class="btn <%= is_found ? 'btn-not-found' : 'btn-found' %>">
                          <%= is_found ? 'X' : '‚úî' %>
                        </button>
                      <% end %>
                    </td>
                    <td>
                      <%= button_to "üóëÔ∏è", item_path(item),
                              method: :delete,
                              class: "btn btn-delete",
                              data: { turbo_confirm: "Voc√™ tem certeza que deseja remover o item '#{item.name}'? Esta a√ß√£o n√£o pode ser desfeita." } %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<script>
  // ==========================================================================
  // FUN√á√ÉO DE INICIALIZA√á√ÉO PRINCIPAL
  // Esta fun√ß√£o cont√©m toda a l√≥gica que precisa de ser executada
  // sempre que a p√°gina √© carregada ou renderizada.
  // ==========================================================================
function initializePage() {
  // --- L√ìGICA PARA MANTER A POSI√á√ÉO DO SCROLL (O seu c√≥digo aqui est√° bom) ---
  const scrolledItemId = sessionStorage.getItem('scroll-to-item-id');
  if (scrolledItemId) {
    const elementToScrollTo = document.getElementById(scrolledItemId);
    if (elementToScrollTo) {
      elementToScrollTo.scrollIntoView({ behavior: 'instant', block: 'center' });
    }
    sessionStorage.removeItem('scroll-to-item-id');
  }

  // --- L√ìGICA PARA RECOLHER/EXPANDIR (ACORDE√ÉO) - VERS√ÉO ROBUSTA ---
  document.querySelectorAll('.collapsible').forEach(header => {
    // Se o listener j√° foi adicionado, n√£o faz nada.
    if (header.dataset.listenerAttached === 'true') {
      return;
    }
    header.dataset.listenerAttached = 'true';

    const container = header.nextElementSibling;

    // Garante que o estado visual corresponde ao estado l√≥gico no carregamento
    if (container.classList.contains('collapsed')) {
      container.style.maxHeight = null; // Garante que est√° fechado
    } else {
      // Define a altura inicial corretamente
      container.style.maxHeight = container.scrollHeight + "px";
    }

    // O evento 'click' √© mais compat√≠vel em dispositivos m√≥veis que 'mousedown'
    header.addEventListener('click', function() {
      // Alterna as classes de estado
      this.classList.toggle('collapsed');
      const content = this.nextElementSibling;
      content.classList.toggle('collapsed');

      // A l√≥gica de anima√ß√£o:
      // Se j√° tem um maxHeight (est√° aberto), fecha-o (define como null).
      // Se n√£o tem (est√° fechado), abre-o (define para a sua altura de scroll).
      if (content.style.maxHeight) {
        content.style.maxHeight = null;
      } else {
        content.style.maxHeight = content.scrollHeight + "px";
      }
    });
  });
}

// ==========================================================================
// EVENT LISTENERS DO TURBO (O seu c√≥digo aqui est√° correto)
// ==========================================================================
document.addEventListener('turbo:load', initializePage);
document.addEventListener('turbo:render', initializePage);

document.addEventListener('turbo:submit-start', function(event) {
  const form = event.target;
  const row = form.closest('tr');
  if (row && row.id) {
    sessionStorage.setItem('scroll-to-item-id', row.id);
  }
});

</script>

